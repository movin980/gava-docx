<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Gov Docs Vault</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6">
  <h1 class="text-3xl font-bold text-blue-600 mb-6">ðŸ“‘ Gov Docs Vault</h1>

  <!-- Auth Section -->
  <div class="bg-white shadow-lg rounded-xl p-6 w-full max-w-md mb-6">
    <h2 class="text-lg font-semibold mb-3">Authentication</h2>
    <input id="email" type="email" placeholder="Email" class="border p-2 rounded w-full mb-2">
    <input id="password" type="password" placeholder="Password" class="border p-2 rounded w-full mb-2">
    <div class="flex gap-2">
      <button id="register" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">Register</button>
      <button id="login" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">Login</button>
      <button id="logout" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">Logout</button>
    </div>
    <div id="user-info" class="mt-3 text-gray-600"></div>
  </div>

  <!-- Upload Section -->
  <div class="bg-white shadow-lg rounded-xl p-6 w-full max-w-md mb-6">
    <h2 class="text-lg font-semibold mb-3">Upload Document</h2>
    <input id="file" type="file" class="block mb-2">
    <input id="enc-key" type="text" placeholder="Encryption key" class="border p-2 rounded w-full mb-2">
    <button id="upload" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded w-full">Encrypt & Save</button>
    <div id="status" class="mt-2 text-sm text-gray-500"></div>
  </div>

  <!-- Documents -->
  <div class="bg-white shadow-lg rounded-xl p-6 w-full max-w-md">
    <h2 class="text-lg font-semibold mb-3">My Documents</h2>
    <div id="docs" class="space-y-3"></div>
  </div>

  <!-- Firebase + CryptoJS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
    import CryptoJS from "https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/+esm";

    // ðŸ”¹ Your Firebase config (fixed bucket removed since no storage)
    const firebaseConfig = {
      apiKey: "AIzaSyBGofjaT3qiGUOAM73gxws4mwyoRAFHioQ",
      authDomain: "document-app-d7764.firebaseapp.com",
      projectId: "document-app-d7764",
      messagingSenderId: "171454029756",
      appId: "1:171454029756:web:5c92ff1edcb5e3d97a95b9",
      measurementId: "G-DVQMMPRQW2"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");
    const info = document.getElementById("user-info");
    const fileEl = document.getElementById("file");
    const keyEl = document.getElementById("enc-key");
    const statusEl = document.getElementById("status");
    const docsEl = document.getElementById("docs");

    // Auth
    document.getElementById("register").onclick = async () => {
      await createUserWithEmailAndPassword(auth, emailEl.value, passEl.value);
    };
    document.getElementById("login").onclick = async () => {
      await signInWithEmailAndPassword(auth, emailEl.value, passEl.value);
    };
    document.getElementById("logout").onclick = async () => {
      await signOut(auth);
    };

    onAuthStateChanged(auth, user => {
      if (user) {
        info.textContent = "Signed in: " + user.email;
        listenDocs(user.uid);
      } else {
        info.textContent = "Not signed in";
        docsEl.innerHTML = "";
      }
    });

    // Listen docs
    let unsub = null;
    function listenDocs(uid) {
      if (unsub) unsub();
      const q = query(collection(db, "users", uid, "documents"), orderBy("uploadedAt", "desc"));
      unsub = onSnapshot(q, snap => {
        docsEl.innerHTML = "";
        snap.forEach(d => {
          const data = d.data();
          const div = document.createElement("div");
          div.className = "p-3 border rounded flex justify-between items-center";
          div.innerHTML = `
            <span class="font-medium">${data.name || "Unnamed"}</span>
            <div class="flex gap-2">
              <button class="bg-blue-500 text-white px-2 py-1 rounded text-sm" data-id="${d.id}" data-data="${data.content}">Download</button>
              <button class="bg-red-500 text-white px-2 py-1 rounded text-sm" data-del="${d.id}">Delete</button>
            </div>
          `;
          docsEl.appendChild(div);
          div.querySelector("[data-id]").onclick = () => downloadAndDecrypt(data.content, data.name);
          div.querySelector("[data-del]").onclick = () => deleteDoc(doc(db, "users", uid, "documents", d.id));
        });
      });
    }

    // Upload encrypted
    document.getElementById("upload").onclick = async () => {
      const file = fileEl.files[0];
      const key = keyEl.value;
      if (!file || !key || !auth.currentUser) return alert("Missing input");

      statusEl.textContent = "Encrypting...";
      const ab = await file.arrayBuffer();
      const wa = CryptoJS.lib.WordArray.create(ab);
      const encrypted = CryptoJS.AES.encrypt(wa, key).toString();

      await addDoc(collection(db, "users", auth.currentUser.uid, "documents"), {
        name: file.name,
        content: encrypted,
        uploadedAt: new Date()
      });

      statusEl.textContent = "Saved!";
      fileEl.value = "";
    };

    // Download + decrypt
    function downloadAndDecrypt(encrypted, filename) {
      const key = prompt("Enter your key:");
      if (!key) return;
      const decrypted = CryptoJS.AES.decrypt(encrypted, key);
      const u8 = new Uint8Array(decrypted.words.length * 4);
      for (let i = 0; i < decrypted.words.length; i++) {
        const word = decrypted.words[i];
        u8[i * 4] = (word >> 24) & 0xff;
        u8[i * 4 + 1] = (word >> 16) & 0xff;
        u8[i * 4 + 2] = (word >> 8) & 0xff;
        u8[i * 4 + 3] = word & 0xff;
      }
      const blob = new Blob([u8], { type: "application/octet-stream" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
    }
  </script>
</body>
</html>
